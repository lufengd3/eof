<script>
    (function() {
         window.EOF = {
            version: '0.0.1',

            register: function(conf) {
                let self = this;
                let thisDoc = document.currentScript.ownerDocument;
                let tpl = thisDoc.querySelector(`#${conf.is}`);
                
                if (!tpl) {
                    throw new Error(`Can't find template Node: ${conf.is}`);
                    return;
                }
                
                let proto = Object.create(HTMLElement.prototype, {
                    createdCallback: {
                        value: function() {
                            let tplContent = self._parseTpl(this, tpl, conf.data);
                            let clone = document.importNode(tplContent, true);
                            let shadowRoot = this.createShadowRoot();
                            
                            shadowRoot.appendChild(clone);
                            self.events.init(shadowRoot, conf.events);
                        }
                    }        
                });

                document.registerElement(conf.is, {prototype: proto});
                self.telemetry._registrate(conf.is);
            },

            telemetry: {
                registions: [],
                _registrate: function(elm) {
                    this.registions.push(elm);
                },
                _regLog: function(elm) {
                     console.log(`<${elm}> registered`);        
                },
                dumpRegistrations: function() {
                    this.registions.forEach(this._regLog);        
                }
            },
            
            /**
             * @param elm, 实例化的标签
             * @param tpl,  template DOM
             * @param data, properties data
             * @return template content DOM
             */
            _parseTpl: function(elm, tpl, data) {
                let self = this;
                
                if (!data) {
                    return tpl.content;
                }
                
                // dom repeat
                
                let tplCopy = tpl.cloneNode(true);
                let tplStr = tplCopy.innerHTML;
                
                for (key in data) {
                    let obj = data[key];
                    let slashType = self.utils.camel2slash(key);
                    //  data.value 可能在elements标签属性上
                    let value = elm.getAttribute(slashType) || obj.value || '';
                    
                    if (obj.type === "object") {
                        if (typeof value === "string") {
                            console.log(elm)
                            console.log(value)
                            value = JSON.parse(decodeURIComponent(value));
                            let keys = Object.keys(value);
                            for (let i = keys.length; i--; ) {
                                let searchStr = `{{\\s${key}.${keys[i]}\\s}}`;
                                if (typeof value[keys[i]] !== "string") {
                                    value[keys[i]] = encodeURIComponent(JSON.stringify(value[keys[i]]));    
                                }
                                tplStr = self.utils.replaceAll(tplStr, [searchStr], value[keys[i]]);        
                            }    
                        }
                        
                        value = encodeURIComponent(JSON.stringify(value));
                    }                    
                    
                    let searchStr = `{{\\s${key}\\s}}`;
                    
                    tplStr = self.utils.replaceAll(tplStr, [searchStr], value);
                    
                }
                
                tplCopy.innerHTML = tplStr;
                
                return tplCopy.content;
            }
        }
    })();
</script>
